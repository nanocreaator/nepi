
#The Collector: Archiving experiment results

An important part of running experiments is collecting the results. This short tutorial explains what are the alterantives to collect and archive results using NEPI.

###The trace method
The basic method to retrieve a result associated to a resource, in a NEPI experiment, is the trace method of the ExperimentController. This method returns a stream containing the data generated by a resource on a specific collection point (trace). A resource might expose many traces, and each of them is associated to a specific trace name. For example, **linux::Application** resources expose **stdout** and **stderr** traces.

<pre><code class="python">print ec.trace(resource, <trace-name>)</code></pre>

###The collector
As a way to expose a simple interface to download and organize results from an experiment, NEPI provides a special resource called Collector. A Collector is used like any other NEPI resource and its job is to automatically download selected traces upon experiment completion, to the local machine running NEPI.

<pre><code class="python">collector = ec.register_resource("Collector")
ec.set(collector, "traceName", <trace-name>)
ec.set(collector, "subDir", <subdir>)
ec.set(collector, "rename", <newname>)
</code></pre>

A Collector will download traces with a specific name (i.e. <trace-name>), to the local experiment run directory (i.e. ec.run_dir). Lets remember that an ExperimentController is associated to a experiment id given by the experimenter, and each time a NEPI experiment is executed (i.e. replicated), a run_id will be assigned to it. The run_id is in fact the timestamp of the start of the experiment run. The run_dir of an experiment is the exp_dir/run_id.

Once a collector resource is registered and configured, it can be connected to another resource to automate trace collection for a certain trace of that resource:

<pre><code class="python">collector = ec.register_resource("Collector")
ec.set(collector, "traceName", "stdout")
ec.set(collector, "subDir", "ping_results")
ec.set(collector, "rename", "ping_output")
ec.register_connection(collector, app)
</code></pre>

In the example above, the standard output trace of an application "app" will be downloaded and stored at run_dir/ping_results/app_guid.ping_output, where app_guid is the unique id assigned to the application resource. Using collectors to store results allows to keep them archived by experiment and run id, and to keep track of which results where generated by which resources.

You can also connect a same Collector to multiple resources, prevented that they all expose the same trace name.

<pre><code class="python">collector = ec.register_resource("Collector")
ec.set(collector, "traceName", "stdout")
ec.set(collector, "subDir", "ping_results")
ec.set(collector, "rename", "ping_output")
ec.register_connection(collector, app1)
ec.register_connection(collector, app2)
ec.register_connection(collector, app3)
</code></pre>

###A collector usage example
You can try copying the code below into an IPython interpreter or running it directly as a nepi script.

<pre><code class="python">from nepi.execution.ec import ExperimentController

ec = ExperimentController(exp_id="collector-exp")

node = ec.register_resource("linux::Node")
ec.set(node, "hostname", "localhost")

app = ec.register_resource("linux::Application")
ec.set(app, "command", "ping -c3 nepi.inria.fr")
ec.register_connection(app, node)

collector = ec.register_resource("Collector")
ec.set(collector, "traceName", "stdout")
ec.set(collector, "subDir", "ping_results")
ec.set(collector, "rename", "ping_output")
ec.register_connection(collector, app)

ec.deploy()
ec.wait_finished(app)
ec.shutdown()

print "RESULT STORED AT", ec.run_dir
</code></pre>

The expected output of the script is something like:

<pre><code class="python">>>
RESULT STORED AT /tmp/collector-exp/20140911165606415281
</code></pre>

Now, you can go and check that the ping_results folder and the ping output file were effectively created in that path:

<pre><code class="python">$ ls /tmp/collector-exp/20140911165606415281
ping_results

$ ls /tmp/collector-exp/20140911165606415281/ping_results/
2.ping_output

$ cat /tmp/collector-exp/20140911165606415281/ping_results/2.ping_output
PING nepi.pl.sophia.inria.fr (138.96.116.79) 56(84) bytes of data.
64 bytes from nepi.pl.sophia.inria.fr (138.96.116.79): icmp_seq=1 ttl=63 time=2.08 ms
64 bytes from nepi.pl.sophia.inria.fr (138.96.116.79): icmp_seq=2 ttl=63 time=1.25 ms
64 bytes from nepi.pl.sophia.inria.fr (138.96.116.79): icmp_seq=3 ttl=63 time=3.80 ms

--- nepi.pl.sophia.inria.fr ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2002ms
rtt min/avg/max/mdev = 1.256/2.383/3.805/1.061 ms
</code></pre>
